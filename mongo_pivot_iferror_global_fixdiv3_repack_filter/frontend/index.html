<!doctype html><html lang="zh"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mongo Pivot Suite • IFERROR 全局兜底（修复 DIV v3 + Upload • repack）</title>
<link rel="stylesheet" href="./styles.css"/><script src="./config.js"></script></head>
<body><div class="container">
  <div class="filter-panel" id="filterPanel">
    <div class="panel-header">
      <h2>筛选器</h2>
      <button class="panel-toggle" id="toggleFilter" title="隐藏/显示筛选器">◀</button>
    </div>
    <div id="filterContainer" class="filter-container">
      <div class="filter-section">
        <h3>行字段筛选</h3>
        <div id="rowFieldFilters" class="filter-list"></div>
      </div>
      <div class="filter-section">
        <h3>指标筛选</h3>
        <div id="metricFieldFilters" class="filter-list"></div>
      </div>
    </div>
    <div class="row">
      <button id="btnClearFilters" class="secondary">清除所有筛选</button>
      <button id="btnApplyFilters">应用筛选</button>
    </div>
    <div class="resize-handle" id="filterResize"></div>
  </div>
  <div class="panel" id="configPanel">
    <div class="panel-header">
      <h1>数据源 & 透视配置</h1>
      <button class="panel-toggle" id="toggleConfig" title="隐藏/显示配置面板">◀</button>
    </div>
    <label>后端 API 根地址</label>
    <input id="apiBase" value="http://localhost:8000"/>
    <div class="row"><button id="btnUseConfig" class="secondary">使用配置地址</button><div class="badge">后端健康</div><div id="health" class="small">...</div></div>

    <div class="row"><label>视图</label><select id="viewMode"><option value="pivot">透视</option><option value="raw">原表</option></select><label>行小计</label><input id="subtotalToggle" type="checkbox"/></div>
    <label>选择集合</label><select id="collection"></select>
    <div class="grid2"><div><label>Limit</label><input id="limit" type="number" value="5000"/></div><div><label>Skip</label><input id="skip" type="number" value="0"/></div></div>
    <label>Filters (JSON)</label><textarea id="filters" rows="4">{}</textarea>
    <div class="row"><span class="badge" id="rowsBadge">Rows: -</span><button id="btnLoad">加载数据 → 透视表</button><button id="btnPeek" class="secondary">查看前 50 条</button><button id="btnExportCsv" class="secondary" disabled>导出 CSV</button></div>

    <h2>本地文件导入（Excel/CSV）</h2>
    <div class="grid2">
      <input type="file" id="fileInput" accept=".csv,.tsv,.txt,.xlsx,.xls,.xlsm"/>
      <input id="sheetInput" placeholder="工作表名或索引(可选)"/>
    </div>
    <div class="grid2">
      <label>从第几行开始读取（1基）<input id="startRow" type="number" min="1" value="1"/></label>
      <button id="btnUpload" class="secondary">读取并加载</button>
    </div>

    <h2>字段管理</h2>
    <div class="fields-box-new">
      <div class="fields-available">
        <h3>可用字段</h3>
        <input id="fieldSearch" placeholder="筛选字段..."/>
        <div id="availableFields" class="list"></div>
      </div>
      <div class="fields-zones">
        <div><h3>行字段</h3><div id="rowsZone" class="dropzone"></div></div>
        <div><h3>列字段</h3><div id="colsZone" class="dropzone"></div></div>
        <div><h3>指标（聚合）</h3><div id="valsZone" class="dropzone"></div></div>
      </div>
    </div>

    <h2>自定义字段</h2>
    <div class="grid2"><input id="calcName" placeholder="avgPrice"/><input id="calcExpr" placeholder="sales / allorder"/></div>
    <button id="btnAddCalc" class="secondary">添加自定义字段</button>
    <div id="computedList" class="computed-list"></div>

    <h2>公式安全设置</h2>
    <div class="row">
      <label class="switch"><input type="checkbox" id="iferrAllToggle"/><span>公式默认 IFERROR 兜底</span></label>
      <label style="width:160px">兜底值<input id="iferrFallback" type="number" step="0.01" value="0"/></label>
    </div>

    <h2>指标格式</h2><div id="formatPanel" class="list"></div>

    <h2>云端配置</h2><div class="row"><label>名称</label><input id="profileName" placeholder="如：看板"/><button id="btnSaveCloud" class="secondary">保存到云端</button><button id="btnLoadCloud" class="secondary">加载</button><button id="btnListCloud" class="secondary">列出</button></div><div id="cloudList" class="small"></div>

    <h2>日志</h2><pre id="log" class="log"></pre>
    <div class="resize-handle" id="configResize"></div>
  </div>
  <div class="panel" style="overflow:auto"><div id="pivotContainer" class="pivot crosshair"></div></div>
</div><script src="./app.js"></script></body></html>
